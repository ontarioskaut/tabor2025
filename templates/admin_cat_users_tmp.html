<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Category Data</title>
    <link rel="stylesheet" href="/static/css/bootstrap.css">
    <script src="/static/js/bootstrap.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.categoryCheckbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function submitBulkTime(event) {
            event.preventDefault();
            const selectedIds = Array.from(document.querySelectorAll('.categoryCheckbox:checked')).map(cb => cb.value);
            const timeOffset = document.getElementById('bulkTimeOffset').value;

            if (selectedIds.length === 0) {
                alert("No category selected.");
                return;
            }

            fetch('/api/admin/bulk_add_user_time_category', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: selectedIds, time_offset: timeOffset })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Bulk update successful!');
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || data.error));
                }
            })
            .catch(err => alert('Request failed: ' + err));
        }
    </script>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <h1 class="mb-4">User Category Data</h1>

        <form id="bulkTimeForm" onsubmit="submitBulkTime(event)" class="row g-3 align-items-center mb-4">
            <div class="col-auto">
                <label for="bulkTimeOffset" class="col-form-label">Time Offset to Add:</label>
            </div>
            <div class="col-auto">
                <input type="text" id="bulkTimeOffset" name="time_offset" class="form-control" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Apply to selected categories</button>
            </div>
        </form>

        <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
                    <th>Category ID</th>
                    <th>Category Name</th>
                    <th style="width: 200px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for cat in categories %}
                <tr>
                    <form onsubmit="handleForms(event, '/api/admin/update_user_category')" class="d-flex gap-2">
                        <input type="hidden" name="category_id" value="{{ cat['user_category_id'] }}">
                        <td><input type="checkbox" class="form-check-input categoryCheckbox" value="{{ cat['user_category_id'] }}"></td>
                        <td class="align-middle">{{ cat['user_category_id'] }}</td>
                        <td><input type="text" name="category_name" value="{{ cat['user_category_name'] }}" class="form-control"></td>
                        <td>
                            <div class="d-flex gap-1">
                                <button type="submit" class="btn btn-sm btn-success">Update</button>
                    </form>
                                <form onsubmit="handleForms(event, '/api/admin/delete_user_category')">
                                    <input type="hidden" name="category_id" value="{{ cat['user_category_id'] }}">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                </tr>
                {% endfor %}

                <!-- New category form -->
                <tr>
                    <form onsubmit="handleForms(event, '/api/admin/add_user_category')" class="d-flex gap-2">
                        <td></td>
                        <td></td>
                        <td><input type="text" name="category_name" placeholder="Name" value="no_name" required class="form-control"></td>
                        <td><button type="submit" class="btn btn-primary">Add user category</button></td>
                    </form>
                </tr>
            </tbody>
        </table>
    </div>
</body>
</html>
