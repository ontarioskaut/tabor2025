<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coin Data</title>
    <link rel="stylesheet" href="/static/css/bootstrap.css">
    <script src="/static/js/bootstrap.js"></script>
    <script src="/static/js/common.js"></script>
    <script>
        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.coinCheckbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function submitBulkTime(event) {
            event.preventDefault();
            const selectedIds = Array.from(document.querySelectorAll('.coinCheckbox:checked')).map(cb => cb.value);
            const timeOffset = document.getElementById('bulkTimeOffset').value;

            if (selectedIds.length === 0) {
                alert("No coins selected.");
                return;
            }

            fetch('/api/admin/bulk_add_coin_time', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    coin_ids: selectedIds,
                    time_offset: timeOffset
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Bulk update successful!');
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || data.error));
                }
            })
            .catch(err => alert('Request failed: ' + err));
        }
    </script>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <h1 class="mb-4">Coin Data</h1>

        <form id="bulkTimeForm" onsubmit="submitBulkTime(event)" class="row g-3 align-items-center mb-4">
            <div class="col-auto">
                <label for="bulkTimeOffset" class="col-form-label">Time Offset to Add:</label>
            </div>
            <div class="col-auto">
                <input type="number" id="bulkTimeOffset" name="time_offset" class="form-control" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Apply to Selected Coins</button>
            </div>
        </form>

        <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
                    <th>Coin ID</th>
                    <th>Coin Tag ID</th>
                    <th>Coin Value</th>
                    <th>Coin Category</th>
                    <th>Category name</th>
                    <th>Last used</th>
                    <th>Is active</th>

                    <th style="width: 200px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for coin in coins %}
                <tr>
                    <form onsubmit="handleForms(event, '/api/admin/update_coin')" class="d-flex gap-2">
                        <input type="hidden" name="coin_id" value="{{ coin['coin_id'] }}">
                        <td><input type="checkbox" class="form-check-input coinCheckbox" value="{{ coin['coin_id'] }}"></td>
                        <td class="align-middle">{{ coin['coin_id'] }}</td>
                        <td><input type="text" name="coin_tag_id" value="{{ coin['coin_tag_id'] }}" class="form-control"></td>
                        <td><input type="text" name="coin_value" value="{{ coin['coin_value'] }}" class="form-control"></td>
                        <td><input type="text" name="coin_category" value="{{ coin['coin_category_id'] }}" class="form-control"></td>
                        <td>{{ coin['coin_category_name'] }}</td>
                        <td><input type="datetime-local" name="last_used" value="{{ coin['last_used'] }}" class="form-control"></td>
                        <td><input type="checkbox" name="is_active" value="1" {% if coin['is_active'] == 1 %}checked{% endif %} class="form-check-input"></td>
                        
                        <td>
                            <div class="d-flex gap-1">
                                <button type="submit" class="btn btn-sm btn-success">Update</button>
                    </form>
                                <form onsubmit="handleForms(event, '/api/admin/delete_coin')">
                                    <input type="hidden" name="coin_id" value="{{ coin['coin_id'] }}">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                </tr>
                {% endfor %}

                <!-- New coin form -->
                <tr>
                    <form onsubmit="handleForms(event, '/api/admin/add_coin')" class="d-flex gap-2">
                        <td></td>
                        <td></td>
                        <td><input type="text" name="coin_tag_id" class="form-control" placeholder="Tag ID" required></td>
                        <td><input type="text" name="coin_value" class="form-control" placeholder="Value" value="1000" required></td>
                        <td><input type="text" name="coin_category" class="form-control" placeholder="Category" value="0" required></td>
                        <td></td>
                        <td><input type="datetime-local" name="last_used" value="1970-01-01 00:00:00" required class="form-control"></td>
                        <td><input type="checkbox" name="is_active" class="form-check-input"></td>
                        <td><button type="submit" class="btn btn-primary">Add Coin</button></td>
                    </form>
                </tr>
            </tbody>
        </table>
    </div>
</body>
</html>
