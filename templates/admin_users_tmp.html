<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Data</title>
    <link rel="stylesheet" href="/static/css/bootstrap.css">
    <script src="/static/js/bootstrap.js"></script>
    <script>
        function handleForms(event, url) {
            event.preventDefault();
            const formData = new FormData(event.target);
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('Operation successful!');
                    window.location.reload();
                }
            })
            .catch(error => {
                alert('An error occurred: ' + error);
            });
        }

        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.userCheckbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function submitBulkTime(event) {
            event.preventDefault();
            const selectedUserIds = Array.from(document.querySelectorAll('.userCheckbox:checked')).map(cb => cb.value);
            const timeOffset = document.getElementById('bulkTimeOffset').value;

            if (selectedUserIds.length === 0) {
                alert("No users selected.");
                return;
            }

            fetch('/bulk_add_user_time', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_ids: selectedUserIds, time_offset: timeOffset })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Bulk update successful!');
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || data.error));
                }
            })
            .catch(err => alert('Request failed: ' + err));
        }
    </script>
</head>
<body class="bg-light">
    <div class="container mt-4">
        <h1 class="mb-4">User Data</h1>

        <form id="bulkTimeForm" onsubmit="submitBulkTime(event)" class="row g-3 align-items-center mb-4">
            <div class="col-auto">
                <label for="bulkTimeOffset" class="col-form-label">Time Offset to Add:</label>
            </div>
            <div class="col-auto">
                <input type="number" id="bulkTimeOffset" name="time_offset" class="form-control" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-primary">Apply to Selected Users</button>
            </div>
        </form>

        <table class="table table-bordered table-striped align-middle">
            <thead class="table-light">
                <tr>
                    <th><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th>
                    <th>User ID</th>
                    <th>User Tag ID</th>
                    <th>Name</th>
                    <th>Acronym</th>
                    <th>Category</th>
                    <th>Time Offset</th>
                    <th>Start Timestamp</th>
                    <th>Displayed</th>
                    <th style="width: 200px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <form onsubmit="handleForms(event, '/admin/update_user')" class="d-flex gap-2">
                        <input type="hidden" name="user_id" value="{{ user['user_id'] }}">
                        <td><input type="checkbox" class="form-check-input userCheckbox" value="{{ user['user_id'] }}"></td>
                        <td class="align-middle">{{ user['user_id'] }}</td>
                        <td><input type="text" name="user_tag_id" value="{{ user['user_tag_id'] }}" class="form-control"></td>
                        <td><input type="text" name="user_name" value="{{ user['user_name'] }}" class="form-control"></td>
                        <td><input type="text" name="user_acro" value="{{ user['user_acro'] }}" class="form-control"></td>
                        <td><input type="text" name="user_category" value="{{ user['user_category'] }}" class="form-control"></td>
                        <td><input type="text" name="user_time_offset" value="{{ user['user_time_offset'] }}" class="form-control"></td>
                        <td><input type="text" name="user_game_start_timestamp" value="{{ user['user_game_start_timestamp'] }}" class="form-control"></td>
                        <td><input type="text" name="is_displayed" value="{{ user['is_displayed'] }}" class="form-control"></td>
                        <td>
                            <div class="d-flex gap-1">
                                <button type="submit" class="btn btn-sm btn-success">Update</button>
                    </form>
                                <form onsubmit="handleForms(event, '/admin/delete_user')">
                                    <input type="hidden" name="user_id" value="{{ user['user_id'] }}">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </div>
                        </td>
                </tr>
                {% endfor %}

                <!-- Add new user form -->
                <tr>
                    <form onsubmit="handleForms(event, '/admin/add_user')" class="d-flex gap-2">
                        <td></td>
                        <td></td>
                        <td><input type="text" name="user_tag_id" placeholder="Tag ID" required class="form-control"></td>
                        <td><input type="text" name="user_name" placeholder="Name" value="no_name" required class="form-control"></td>
                        <td><input type="text" name="user_acro" placeholder="Acronym" value="x" required class="form-control"></td>
                        <td><input type="text" name="user_category" placeholder="Category" value="0" required class="form-control"></td>
                        <td><input type="text" name="user_time_offset" placeholder="Time Offset" value="0" required class="form-control"></td>
                        <td><input type="text" name="user_game_start_timestamp" placeholder="Game Start Timestamp" value="{{current_time}}" required class="form-control"></td>
                        <td><input type="text" name="is_displayed" placeholder="Displayed" value="1" required class="form-control"></td>
                        <td><button type="submit" class="btn btn-primary">Add User</button></td>
                    </form>
                </tr>
            </tbody>
        </table>
    </div>
</body>
</html>
