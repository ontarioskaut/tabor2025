<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Data</title>
    <script>
        /*function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                fetch(`/admin/delete_user/${userId}`, {
                    method: 'POST',
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload(); // Reload the page to reflect changes
                    } else {
                        alert('Failed to delete user');
                    }
                });
            }
        }*/

        function handleForms(event, url) {
            event.preventDefault()
            const formData = new FormData(event.target);
            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    alert('Operation successful!');
                    window.location.reload(); // Reload the page to reflect changes
                }
            })
            .catch(error => {
                alert('An error occurred: ' + error);
            });
        }

        function toggleAllCheckboxes(source) {
            const checkboxes = document.querySelectorAll('.userCheckbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }

        function submitBulkTime(event) {
            event.preventDefault();

            const selectedUserIds = Array.from(document.querySelectorAll('.userCheckbox:checked')).map(cb => cb.value);
            const timeOffset = document.getElementById('bulkTimeOffset').value;

            if (selectedUserIds.length === 0) {
                alert("No users selected.");
                return;
            }

            fetch('/bulk_add_user_time', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    user_ids: selectedUserIds,
                    time_offset: timeOffset
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Bulk update successful!');
                    window.location.reload();
                } else {
                    alert('Error: ' + (data.message || data.error));
                }
            })
            .catch(err => alert('Request failed: ' + err));
        }

    </script>
</head>
<body>
    <h1>User Data</h1>
    <form id="bulkTimeForm" onsubmit="submitBulkTime(event)">
        <label>Time Offset to Add: <input type="number" id="bulkTimeOffset" name="time_offset" required></label>
        <button type="submit">Apply to Selected Users</button>
    </form>
<br>
    <table border="1">
        <thead>
            <tr>
                <th><input type="checkbox" onclick="toggleAllCheckboxes(this)"></th> <!-- Select All -->
                <th>User ID</th>
                <th>User Tag ID</th>
                <th>User Name</th>
                <th>User Acronym</th>
                <th>User Category</th>
                <th>User Time Offset</th>
                <th>Start Timestamp</th>
                <th>Is displayed</th>

                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
        <tr>
            <!-- Update form -->
            <form onsubmit="handleForms(event, '/admin/update_user')">
                <input type="hidden" name="user_id" value="{{ user['user_id'] }}">
                <td><input type="checkbox" class="userCheckbox" value="{{ user['user_id'] }}"></td>
                <td>{{ user['user_id'] }}</td>
                <td><input type="text" name="user_tag_id" value="{{ user['user_tag_id'] }}"></td>
                <td><input type="text" name="user_name" value="{{ user['user_name'] }}"></td>
                <td><input type="text" name="user_acro" value="{{ user['user_acro'] }}"></td>
                <td><input type="text" name="user_category" value="{{ user['user_category'] }}"></td>
                <td><input type="text" name="user_time_offset" value="{{ user['user_time_offset'] }}"></td>
                <td><input type="text" name="user_game_start_timestamp" value="{{ user['user_game_start_timestamp'] }}"></td>
                <td><input type="text" name="is_displayed" value="{{ user['is_displayed'] }}"></td>

                <td style="display: flex; gap: 4px;">
                    <button type="submit">Update</button>
                    </form>
                    <!-- Delete form (separate, but visually inline) -->
                    <form onsubmit="handleForms(event, '/admin/delete_user')">
                        <input type="hidden" name="user_id" value="{{ user['user_id'] }}">
                        <button type="submit">Delete</button>
                    </form>
                </td>
        </tr>

            {% endfor %}
            <!-- new user form -->
            <tr>
                <form onsubmit="handleForms(event, '/admin/add_user')">
                    <td></td> <!-- User ID will be auto-generated -->
                    <td></td>
                    <td><input type="text" name="user_tag_id" placeholder="Tag ID" required></td>
                    <td><input type="text" name="user_name" placeholder="Name" value="no_name" required></td>
                    <td><input type="text" name="user_acro" placeholder="Acronym" value="x" required></td>
                    <td><input type="text" name="user_category" placeholder="Category" value="0" required></td>
                    <td><input type="text" name="user_time_offset" placeholder="Time Offset" value="0" required></td>
                    <td><input type="text" name="user_game_start_timestamp" placeholder="Game Start Timestamp" value="{{current_time}}" required></td>
                    <td><input type="text" name="is_displayed" placeholder="idk" value="1" required></td>
                    <td><button type="submit">Add User</button></td>

                </form>
            </tr>
        </tbody>
    </table>
</body>
</html>
